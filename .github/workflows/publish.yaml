name: Quarto Publish
run-name: ${{ github.event_name }} on ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'  # 7:00 JST daily full build
  push:
    branches: main

permissions: {}

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: 'Asia/Tokyo'
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Detect changes
        uses: tj-actions/changed-files@e0021407031f5be11a464abee9a0776171c79891 # v47.0.1
        id: filter
        with:
          files: |
            blog/**
            slides/**
            resume/**
            zenn/**
            index.qmd
            about.qmd
            404.qmd
            _quarto.yaml
            assets/**

      - name: Configure Git
        run: |
          git config --global init.defaultBranch main
          git config --global advice.defaultBranchName false

      - name: Fix timestamps
        run: |
          bash ${{ github.workspace }}/.github/scripts/fix-timestamps.sh

      - name: Update Quarto config
        env:
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
        run: |
          sed -i "s/GOOGLE_ANALYTICS_PLACEHOLDER/${{ secrets.GOOGLE_ANALYTICS_ID }}/g" _quarto.yaml
          sed -i "s/YEAR_PLACEHOLDER/$(TZ='Asia/Tokyo' date +%Y)/g" _quarto.yaml

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          cache: true

      - name: Cache uv dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.cache/uv
            ~/.cache/ms-playwright
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: uv-${{ runner.os }}-

      - name: Cache Quarto freeze
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: _freeze/
          key: quarto-freeze-${{ github.sha }}
          restore-keys: quarto-freeze-

      - name: Set up Python dependencies
        run: mise exec -- uv sync

      - name: Install Playwright
        run: mise exec -- uv run playwright install chromium

      - name: Checkout gh-pages as _site base
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: gh-pages
          path: _site
          persist-credentials: false

      - name: Build site
        env:
          PARALLEL_JOBS: ${{ env.PARALLEL_JOBS }}
          EVENT_NAME: ${{ github.event_name }}
          CHANGED_FILES: ${{ steps.filter.outputs.all_changed_files }}
        run: |
          if [ "$EVENT_NAME" = "push" ] && [ -n "$CHANGED_FILES" ]; then
            # shellcheck disable=SC2086
            mise run build-site $CHANGED_FILES
          else
            # workflow_dispatch: full build
            mise run build-site
          fi

      - name: Fix image paths and links in GFM files
        run: mise exec -- uv run python .github/scripts/fix-gfm-paths.py _site/

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
