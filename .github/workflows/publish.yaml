name: Quarto Publish
run-name: ${{ github.event_name }} on ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
  push:
    branches: main

permissions: {}  # 各ジョブで必要な権限を明示的に与えるためにすべて無効にする

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}  # 同一PRでの多重起動を抑制する
  cancel-in-progress: true  # 既存の実行をキャンセルして新しい実行を開始させる

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: 'Asia/Tokyo'
    steps:
      - name: Check out repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git
        run: |
          git config --global init.defaultBranch main
          git config --global advice.defaultBranchName false

      - name: Fix timestamps
        run: |
          bash ${{ github.workspace }}/.github/scripts/fix-timestamps.sh

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          install_args: --yes
          cache: true

      - name: Cache uv dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/uv
            ~/.cache/ms-playwright
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Set up Python dependencies
        run: |
          mise exec -- uv sync
          mise exec -- uv run playwright install chromium

      - name: Cache Quarto freeze
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _freeze/
          key: quarto-freeze-${{ hashFiles('**/*.qmd') }}
          restore-keys: |
            quarto-freeze-

      - name: Cache _site directory
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: _site/
          key: site-${{ github.sha }}
          restore-keys: |
            site-

      - name: Fetch Zenn articles
        run: |
          mise exec -- uv run python .github/scripts/fetch_zenn_articles.py

      - name: Update Quarto config
        env:
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
        run: |
          sed -i "s/GOOGLE_ANALYTICS_PLACEHOLDER/${{ secrets.GOOGLE_ANALYTICS_ID }}/g" _quarto.yml
          sed -i "s/YEAR_PLACEHOLDER/$(TZ='Asia/Tokyo' date +%Y)/g" _quarto.yml

      - name: Detect changed files
        id: changes
        run: |
          # Detect changed .qmd files from the last commit
          # If this is the first build or cache miss, render all files
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            CHANGED=$(git diff --name-only HEAD^ HEAD | grep '\.qmd$' || echo "")
          else
            # First commit - render all files
            CHANGED=""
            FORCE_FULL_RENDER="true"
          fi

          # If workflow_dispatch was triggered manually, remove _site/ for clean build
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected, removing _site/ for clean build"
            rm -rf _site
            FORCE_FULL_RENDER="true"
          fi

          # If _site cache was not restored, force full render
          if [ ! -d "_site" ] || [ -z "$(ls -A _site 2>/dev/null)" ]; then
            FORCE_FULL_RENDER="true"
          fi

          if [ "$FORCE_FULL_RENDER" = "true" ]; then
            echo "Full render triggered"
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            # Dynamically determine which index files to rebuild based on changed directories
            ALWAYS_BUILD=""

            if [ -n "$CHANGED" ]; then
              # If any change exists, always rebuild root index.qmd
              ALWAYS_BUILD="index.qmd"

              # Check if blog/ has changes
              if echo "$CHANGED" | grep -q "^blog/"; then
                ALWAYS_BUILD="$ALWAYS_BUILD blog/index.qmd"
              fi

              # Check if slides/ has changes
              if echo "$CHANGED" | grep -q "^slides/"; then
                ALWAYS_BUILD="$ALWAYS_BUILD slides/index.qmd"
              fi

              # Check if resume/ has changes
              if echo "$CHANGED" | grep -q "^resume/"; then
                ALWAYS_BUILD="$ALWAYS_BUILD resume/index.qmd"
              fi
            fi

            # Combine changed files and always-build files, remove duplicates
            FILES_TO_RENDER=$(echo "$CHANGED $ALWAYS_BUILD" | tr ' ' '\n' | sort -u | tr '\n' ' ')
            echo "files=$FILES_TO_RENDER" >> "$GITHUB_OUTPUT"
            echo "mode=selective" >> "$GITHUB_OUTPUT"
            echo "Changed or always-build files: $FILES_TO_RENDER"
          fi

      - name: Render Quarto Project (Full)
        if: steps.changes.outputs.mode == 'full'
        run: |
          # Let Quarto manage directory structure for full builds
          mise exec -- uv run quarto render

      - name: Render Quarto Project (Selective)
        if: steps.changes.outputs.mode == 'selective'
        env:
          FILES_TO_RENDER: ${{ steps.changes.outputs.files }}
        run: |
          if [ -n "$FILES_TO_RENDER" ]; then
            echo "Rendering changed/always-build files: $FILES_TO_RENDER"
            for file in $FILES_TO_RENDER; do
              if [ -f "$file" ]; then
                echo "Rendering $file (all formats)"
                mise exec -- uv run quarto render "$file" --no-clean
              fi
            done
          else
            echo "No files to render"
          fi

      - name: Generate PDF from Reveal.js slides (Full)
        if: steps.changes.outputs.mode == 'full'
        run: |
          for html in _site/slides/*.html; do
            if [ -f "$html" ]; then
              pdf="${html%.html}.pdf"
              echo "Converting $html to $pdf"
              mise exec -- uvx deck2pdf@0.9.0 "$html" "$pdf" || echo "Warning: Failed to convert $html"
            fi
          done

      - name: Generate PDF from Reveal.js slides (Selective)
        if: steps.changes.outputs.mode == 'selective'
        env:
          FILES_TO_RENDER: ${{ steps.changes.outputs.files }}
        run: |
          for file in $FILES_TO_RENDER; do
            if [[ "$file" == slides/*.qmd ]]; then
              html="_site/${file%.qmd}.html"
              pdf="${html%.html}.pdf"
              if [ -f "$html" ]; then
                echo "Converting $html to $pdf"
                mise exec -- uvx deck2pdf@0.9.0 "$html" "$pdf" || echo "Warning: Failed to convert $html"
              fi
            fi
          done

      - name: Generate PDF from resume (Full)
        if: steps.changes.outputs.mode == 'full'
        run: |
          mise exec -- uv run python .github/scripts/html_to_pdf.py \
            ${{ github.workspace }}/_site/resume/index.html \
            _site/resume/index.pdf

      - name: Generate PDF from resume (Selective)
        if: steps.changes.outputs.mode == 'selective'
        env:
          FILES_TO_RENDER: ${{ steps.changes.outputs.files }}
        run: |
          if echo "$FILES_TO_RENDER" | grep -q "resume/index.qmd"; then
            echo "Generating resume PDF"
            mise exec -- uv run python .github/scripts/html_to_pdf.py \
              ${{ github.workspace }}/_site/resume/index.html \
              _site/resume/index.pdf
          else
            echo "Resume not changed, skipping PDF generation"
          fi

      - name: Fix image paths and links in GFM files
        run: |
          # 画像パスを絶対URLに変換 (相対パス)
          find _site -name "*.md" -type f -exec sed -i 's|(\.\./assets/|(https://i9wa4.github.io/assets/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|src="\.\./assets/|src="https://i9wa4.github.io/assets/|g' {} \;

          # 画像パスを絶対URLに変換 (絶対パス)
          find _site -name "*.md" -type f -exec sed -i 's|](/assets/|](https://i9wa4.github.io/assets/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|src="/assets/|src="https://i9wa4.github.io/assets/|g' {} \;

          # 記事への相対リンクを絶対URLに変換 (.qmd -> .md)
          find _site -name "*.md" -type f -exec sed -i 's|(\([^)]*\)\.qmd)|(https://i9wa4.github.io/\1.md)|g' {} \;

          # 相対パスを絶対URLに変換 (../blog/, ../slides/, ../resume/)
          find _site -name "*.md" -type f -exec sed -i 's|(../blog/|(https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(../slides/|(https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(../resume/|(https://i9wa4.github.io/resume/|g' {} \;

          # 相対パスを絶対URLに変換 (./blog/, ./slides/, ./resume/)
          find _site -name "*.md" -type f -exec sed -i 's|(./blog/|(https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(./slides/|(https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(./resume/|(https://i9wa4.github.io/resume/|g' {} \;

          # 絶対パス形式を絶対URLに変換 (/blog/, /slides/, /resume/)
          find _site -name "*.md" -type f -exec sed -i 's|](/blog/|](https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|](/slides/|](https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|](/resume/|](https://i9wa4.github.io/resume/|g' {} \;

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
