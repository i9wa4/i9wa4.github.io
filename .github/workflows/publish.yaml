name: Quarto Publish
run-name: ${{ github.event_name }} on ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
  push:
    branches: main

permissions: {}

env:
  CONTENT_DIRS: blog resume root slides zenn
  FEED_DIRS: blog
  FULL_REBUILD_TRIGGERS: _extensions/ _includes/ themes/ _quarto.yaml

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      full_rebuild: ${{ steps.detect.outputs.full_rebuild }}
      has_builds: ${{ steps.detect.outputs.has_builds }}
      matrix: ${{ steps.detect.outputs.matrix }}

    steps:
      - name: Check out repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get last deployed SHA
        id: deployed
        run: |
          sha=$(git show origin/gh-pages:.deployed-sha 2>/dev/null || echo "")
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Detect changed files
        uses: tj-actions/changed-files@e0021407031f5be11a464abee9a0776171c79891 # v47.0.1
        id: changes
        with:
          base_sha: ${{ steps.deployed.outputs.sha }}
          files: |
            _extensions/**
            _includes/**
            _quarto.yaml
            assets/**
            blog/**
            resume/**
            slides/**
            themes/**
            zenn/**
            '*.qmd'

      - name: Set build matrix
        id: detect
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ADDED_FILES: ${{ steps.changes.outputs.added_files }}
          EVENT_NAME: ${{ github.event_name }}
        run: bash .github/scripts/detect-changes.sh "$CHANGED_FILES"

  build-content:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_builds == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: "Asia/Tokyo"
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - name: Check out repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Fix timestamps
        run: bash .github/scripts/fix-timestamps.sh

      - name: Update Quarto config
        run: |
          sed -i "s/GOOGLE_ANALYTICS_PLACEHOLDER/${{ secrets.GOOGLE_ANALYTICS_ID }}/g" _quarto.yaml
          sed -i "s/YEAR_PLACEHOLDER/$(TZ='Asia/Tokyo' date +%Y)/g" _quarto.yaml

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1

      - name: Cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/.cache/ms-playwright
          key: |
            cache-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            cache-${{ runner.os }}-${{ runner.arch }}-

      - name: Set up Python dependencies
        run: uv sync

      - name: Install Playwright
        if: matrix.dir == 'resume'
        run: uv run playwright install chromium

      - name: Render
        env:
          BUILD_DIR: ${{ matrix.dir }}
          BUILD_FILE: ${{ matrix.file }}
          BUILD_MODE: ${{ matrix.mode }}
        run: |
          # NOTE: single mode disabled for deployment stability - always do full directory build
          # if [ "$BUILD_MODE" = "single" ]; then
          #   uv run quarto render "$BUILD_FILE"
          #   [ "$BUILD_DIR" != "root" ] && uv run quarto render "$BUILD_DIR/index.qmd"
          # fi
          if [ "$BUILD_DIR" = "root" ]; then
            for page in *.qmd; do uv run quarto render "$page"; done
          else
            uv run quarto render "$BUILD_DIR/"
          fi

      - name: Generate PDF
        if: matrix.dir == 'slides' || matrix.dir == 'resume'
        env:
          BUILD_DIR: ${{ matrix.dir }}
        run: |
          if [ "$BUILD_DIR" = "slides" ]; then
            for html in _site/slides/*.html; do
              [ "$(basename "$html")" = "index.html" ] && continue
              uvx deck2pdf@0.9.0 "$html" "${html%.html}.pdf" &
            done
            wait
          else
            uv run python .github/scripts/html-to-pdf.py \
              _site/resume/index.html _site/resume/index.pdf
          fi

      - name: Fix image paths and links in GFM files
        run: uv run python .github/scripts/fix-gfm-paths.py _site/

      - name: Prepare artifact
        env:
          BUILD_DIR: ${{ matrix.dir }}
        run: |
          if [ "$BUILD_DIR" = "root" ]; then
            mkdir -p _site/root
            mv _site/*.html _site/*.md _site/root/ 2>/dev/null || true
          fi
          # Include site_libs in each artifact for merge
          if [ -d "_site/site_libs" ]; then
            cp -r _site/site_libs "_site/${BUILD_DIR}/_site_libs"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: site-${{ matrix.dir }}
          path: _site/${{ matrix.dir }}/
          retention-days: 1

  deploy:
    needs: [detect-changes, build-content]
    if: always() && needs.detect-changes.result == 'success' && needs.build-content.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TZ: "Asia/Tokyo"
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Checkout gh-pages as _site base (incremental)
        if: needs.detect-changes.outputs.full_rebuild != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          path: _site
          persist-credentials: false
          ref: gh-pages

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: _artifacts

      - name: Merge artifacts into _site
        env:
          FULL_REBUILD: ${{ needs.detect-changes.outputs.full_rebuild }}
        run: |
          mkdir -p _site
          for artifact_dir in _artifacts/site-*; do
            [ -d "$artifact_dir" ] || continue
            dir_name="${artifact_dir##*/site-}"
            # Merge _site_libs from each artifact
            if [ -d "$artifact_dir/_site_libs" ]; then
              mkdir -p _site/site_libs
              cp -r "$artifact_dir/_site_libs/"* _site/site_libs/ 2>/dev/null || true
              rm -rf "$artifact_dir/_site_libs"
            fi
            if [ "$dir_name" = "root" ]; then
              mv "$artifact_dir"/*.html "$artifact_dir"/*.md _site/ 2>/dev/null || true
            else
              # Always remove target dir to ensure clean copy (fixes incremental deploy issue)
              rm -rf "_site/${dir_name}"
              mkdir -p "_site/${dir_name}"
              cp -r "$artifact_dir"/* "_site/${dir_name}/"
            fi
          done
          rm -rf _artifacts
          # Copy assets from source
          rm -rf _site/assets
          cp -r assets _site/assets
          # Record deployed commit SHA for incremental builds
          echo "${{ github.sha }}" > _site/.deployed-sha

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          force_orphan: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
