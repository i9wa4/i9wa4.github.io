name: Quarto Publish
run-name: ${{ github.event_name }} on ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
  push:
    branches: main

permissions: {}  # 各ジョブで必要な権限を明示的に与えるためにすべて無効にする

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}  # 同一PRでの多重起動を抑制する
  cancel-in-progress: true  # 既存の実行をキャンセルして新しい実行を開始させる

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: 'Asia/Tokyo'
    steps:
      - name: Check out repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Fix timestamps
        run: |
          bash ${{ github.workspace }}/.github/scripts/fix-timestamps.sh

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@9e48da27e184aa238fcb49f5db75469626d43adb # v2.1.9
        with:
          version: 1.8.25

      - name: (Optional) Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0

      - name: Set up uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2

      - name: (Optional) Set up Jupyter
        run: python3 -m pip install jupyter==1.1.1

      - name: Fetch Zenn articles
        run: python3 .github/scripts/fetch_zenn_articles.py

      - name: Update Quarto config
        env:
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
        run: |
          sed -i "s/GOOGLE_ANALYTICS_PLACEHOLDER/${{ secrets.GOOGLE_ANALYTICS_ID }}/g" _quarto.yml
          sed -i "s/YEAR_PLACEHOLDER/$(TZ='Asia/Tokyo' date +%Y)/g" _quarto.yml

      - name: Render Quarto Project
        run: |
          # Workaround for Quarto bug where HTML files remain in blog/ after multi-format rendering (HTML + GFM).
          # Quarto tries to move these files to _site/blog/ but fails with "No such file or directory" error
          # because some files are already in _site/blog/ while others remain in blog/.
          # This affects the last file in rendering order (83/83), causing the build to fail.
          # Ignore the error and manually move any remaining HTML files to _site/blog/.
          # Issue observed with Quarto 1.7.32 and 1.8.25.
          quarto render || true
          # Move any HTML files that remain in blog/ to _site/blog/
          find blog -name "*.html" -type f -exec mv {} _site/blog/ \; 2>/dev/null || true

      - name: Generate PDF from Reveal.js slides
        run: |
          for html in _site/slides/*.html; do
            if [ -f "$html" ]; then
              pdf="${html%.html}.pdf"
              echo "Converting $html to $pdf"
              uvx deck2pdf@0.9.0 "$html" "$pdf" || echo "Warning: Failed to convert $html"
            fi
          done

      - name: Generate PDF from resume
        run: |
          uvx --with playwright==1.55.0 python .github/scripts/html_to_pdf.py \
            ${{ github.workspace }}/_site/resume/index.html \
            _site/resume/index.pdf

      - name: Fix image paths and links in GFM files
        run: |
          # 画像パスを絶対URLに変換 (相対パス)
          find _site -name "*.md" -type f -exec sed -i 's|(\.\./assets/|(https://i9wa4.github.io/assets/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|src="\.\./assets/|src="https://i9wa4.github.io/assets/|g' {} \;

          # 画像パスを絶対URLに変換 (絶対パス)
          find _site -name "*.md" -type f -exec sed -i 's|](/assets/|](https://i9wa4.github.io/assets/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|src="/assets/|src="https://i9wa4.github.io/assets/|g' {} \;

          # 記事への相対リンクを絶対URLに変換 (.qmd -> .md)
          find _site -name "*.md" -type f -exec sed -i 's|(\([^)]*\)\.qmd)|(https://i9wa4.github.io/\1.md)|g' {} \;

          # 相対パスを絶対URLに変換 (../blog/, ../slides/, ../resume/)
          find _site -name "*.md" -type f -exec sed -i 's|(../blog/|(https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(../slides/|(https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(../resume/|(https://i9wa4.github.io/resume/|g' {} \;

          # 相対パスを絶対URLに変換 (./blog/, ./slides/, ./resume/)
          find _site -name "*.md" -type f -exec sed -i 's|(./blog/|(https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(./slides/|(https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|(./resume/|(https://i9wa4.github.io/resume/|g' {} \;

          # 絶対パス形式を絶対URLに変換 (/blog/, /slides/, /resume/)
          find _site -name "*.md" -type f -exec sed -i 's|](/blog/|](https://i9wa4.github.io/blog/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|](/slides/|](https://i9wa4.github.io/slides/|g' {} \;
          find _site -name "*.md" -type f -exec sed -i 's|](/resume/|](https://i9wa4.github.io/resume/|g' {} \;

      - name: Publish to GitHub Pages
        uses: quarto-dev/quarto-actions/publish@9e48da27e184aa238fcb49f5db75469626d43adb # v2.1.9
        with:
          target: gh-pages
          render: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
