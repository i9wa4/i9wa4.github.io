---
title: Mosaic AI Gateway でコーディングエージェントを配るための運用Tips
author:
  - name: uma-chan
categories:
  - "slides"
  - "genda"
date: 2026-01-27
date-modified: last-modified
description: |
  [登壇資料] 2026-01-27 JEDAI 2026 新春 Meetup
draft: true
image: "/assets/common/icon_hhkb3_large.jpg"
format:
  revealjs:
    auto-stretch: false
    code-copy: true
    footer: "[2026-01-27 JEDAI 2026 新春 Meetup](https://jedai.connpass.com/event/379174/)"
    include-in-header:
      - ../_includes/hatena-nocomment.html
    incremental: false
    scrollable: true
    slide-level: 3
    slide-number: true
    smaller: false
    theme:
      - simple
      - ../themes/font.scss
    title-prefix: ""
    toc-depth: 2
    toc: false
    height: 1080
    width: 1920
  gfm: default
subtitle: ""
---

## 自己紹介

uma-chan

株式会社GENDA IT戦略部 データチーム

データエンジニア / MLOpsエンジニア

### 今日話すこと

Mosaic AI Gatewayを活用してAIコーディングエージェントを組織内に展開した話

- データ基盤の費用に集約しながらAIコーディングエージェントを配る
- 認証設定だけで渡せる仕組み
- ヘビーユーザー以外には有効なアプローチ

## こういう場面ありませんか?

### AIコーディングエージェントを配りたいけど

- 一時的に作業してくれる方にAIコーディング環境を用意したい
- 技術に詳しくない部門のメンバーもAIコーディングエージェントを活用したい

### 対象ユーザー

<!--
図: target-users.drawio.png
説明: AI Gateway配布の対象ユーザーを適性で分類した図
要素:
  - 適している: インターン・外部協力者、技術部門以外（データアナリスト等）、Databricks外の予算がない人、今すぐ使いたい人
  - 適していない: ヘビーユーザー（大量利用）、リアルタイム遮断が必要な場合
  - ポイント: 指定した間隔で予算超過を検知。例えば15分間隔ならライトユーザーが予算を使い切ることはほぼない
-->
![対象ユーザー](/assets/2026-01-27-jedai-ai-gateway/target-users.drawio.png)

### その他の課題

契約調整の手間

- 新規サービスを使うには契約調整が必要
- OpenAI、Anthropicなど個別に契約すると管理が煩雑
- 「来週から使いたい」に間に合わないことも

人の増減への対応

- 一時メンバーが入るたびに契約調整
- 終了時のアカウント停止も手間

野放しは怖い

- 従量課金で上限なし → 月末に請求書で心臓止まる
- かといって自前でProxy構築は工数がかかる

## Before/After

### 比較

<!--
図: before-after.drawio.png
説明: AI Gateway導入前後の運用負荷を比較した図
要素:
  - Before: 導入まで（新規契約の稟議待ち）、人の増減（都度契約調整）、請求管理（外部サービスごとに分散）、利用料管理（制限なし or 自前で構築）
  - After: 導入まで（認証設定ですぐ）、人の増減（認証設定とRate Limitだけ）、請求管理（Databricksに一本化）、利用料管理（監視JobとRate Limit API）
-->
![Before/After](/assets/2026-01-27-jedai-ai-gateway/before-after.drawio.png)

## Databricks完結という選択

### 外部サービス不要

- Databricksだけで完結できる
- 外部DB、外部Proxy、外部認証サービス不要
- 既存のDatabricks環境にそのまま乗せられる

### AI Gatewayの機能

Mosaic AI Gatewayが提供するもの

- 複数LLMへの統一エンドポイント (Claude, GPT, Llama等)
- Pay-per-token の従量課金
- system.serving.endpoint_usage による使用量追跡

### 認証設定ですぐ渡せる

- databricks auth loginでOAuth認証
- 環境変数とコマンド1つだけ
- 5分でAIコーディング環境が渡せる

<!--
図: auth-flow.drawio.png
説明: U2M OAuth認証によるAI Gateway接続フロー
要素:
  - Step 1: databricks auth loginでブラウザ認証
  - Step 2: 自動的にトークンが取得・更新される
  - Step 3: コーディングエージェントがAI Gatewayに接続
  - ポイント: Token管理不要、環境変数とコマンド1つで完結
-->
<!--
TODO: DATABRICKS_HOSTが必要かどうか要検証
- Gooseが~/.databrickscfgからhostを読めるなら不要
- 環境変数が必須なら現状のままでOK
-->
![認証フロー](/assets/2026-01-27-jedai-ai-gateway/auth-flow.drawio.png)

### 請求集約

- データ基盤の請求に集約
- 経費管理がシンプルに

## 採用した構成

### Databricks内で完結

<!--
図: databricks-infrastructure.drawio.png
説明: Databricks内で完結する予算管理・遮断の構成図
要素:
  - Mosaic AI Gateway: 統一エンドポイント、Pay-per-token
  - endpoint_usage: system.servingの使用量テーブル（自動記録）
  - 監視Job: 指定間隔で予算超過を検知
  - Databricks Job: Rate Limit設定、自動遮断処理
  - Service Principal: インフラ管理、Rate Limit制御
  - 予算テーブル: ユーザー別上限設定（Delta Table）
  - ポイント: 外部DB、外部Proxy、外部認証サービス一切不要
-->
![基盤構成](/assets/2026-01-27-jedai-ai-gateway/databricks-infrastructure.drawio.png)

### 全体アーキテクチャ

<!--
図: overall-architecture.drawio.png
説明: システム全体の構成を示すアーキテクチャ図
要素:
  - ユーザー: コーディングエージェント利用者
  - コーディングエージェント: Goose、Aider、Claude Code等
  - Mosaic AI Gateway: 統一エンドポイント（認証、ルーティング、使用量記録）
  - LLMs: Claude、GPT-4、Llama、Gemini等
  - 監視・遮断: SQL Alert、Databricks Job、Rate Limit API
-->
![全体アーキテクチャ](/assets/2026-01-27-jedai-ai-gateway/overall-architecture.drawio.png)

### 設計の考え方

Databricks完結を最優先に選定

![設計の考え方](/assets/2026-01-27-jedai-ai-gateway/three-options-comparison.drawio.png)

### なぜ案Cを選んだか

- 対象: 同時数名程度、ライトユーザー向け
- 実装工数最低: SQLとJobだけ
- 必要になったら案A/Bに移行できる設計

## 運用の割り切り

### 予算上限の設計

- ユーザーごとに月額上限を自由に設定できる
- 上限に達したらRate Limitでアクセス遮断
- 「野放しにしない」安心感

### 遅延の許容

- リアルタイム遮断は本当に必要か?
- 例えば15分間隔なら、ライトユーザーが予算を使い切ることはない
- 過剰設計をやめたら構成がシンプルになった

#### KPI実績

- 予算超過検知遅延: 設定間隔以内（例: 15分）
- アクセス遮断成功率: 100%

### Dev Container統合

- 環境変数でEndpoint URL設定
- Dev Containerに1行追加するだけ
- 構成がシンプルなので組み込みやすい

<!--
図: dev-environment.drawio.png
説明: Dev ContainerとAI Gatewayの統合構成図
要素:
  - Dev Container: 環境変数（GOOSE_PROVIDER）と~/.databrickscfg設定
  - コーディングエージェント: Goose（推奨）、Aider、Claude Code
  - 注釈: Aider: PAT、Claude Code: LiteLLM経由
  - Mosaic AI Gateway: 認証、ルーティング、使用量記録
  - LLMs: Claude、GPT-4、Llama、Gemini
  - ポイント: U2M OAuth認証でToken管理不要、環境変数1つとdatabricks auth loginだけで完成
-->
![開発環境統合](/assets/2026-01-27-jedai-ai-gateway/dev-environment.drawio.png)

## コーディングエージェントとの相性

### エージェント接続図

<!--
図: agent-connection.drawio.png
説明: 各コーディングエージェントとAI Gatewayの接続方法を示す図
要素:
  - Goose: Databricks Providerをネイティブサポート、推奨
  - Aider: OpenAI互換API経由で接続
  - Claude Code: LiteLLM経由で接続
  - jupyter-databricks-kernel: JupyterからDatabricksクラスタに接続
  - Mosaic AI Gateway: 全エージェントの統一接続先
-->
![エージェント接続](/assets/2026-01-27-jedai-ai-gateway/agent-connection.drawio.png)

### Goose

- Block社製のOSSコーディングエージェント
- Databricks Providerをネイティブサポート
- AI Gatewayとの接続がスムーズ

### jupyter-databricks-kernel

- JupyterからDatabricksクラスタに接続
- ローカルのNotebook環境からDatabricksのLLMを利用可能
- 開発体験を損なわずにDatabricks完結

### その他のエージェント

- Aider: OpenAI互換APIに対応
- Claude Code: Anthropic APIに対応
- AI Gatewayが複数モデルを統一エンドポイントで提供

## まとめ

### 今日のポイント

1. 認証設定だけでAIコーディング環境が渡せる
2. Databricks完結、外部サービス不要
3. ヘビーユーザー以外には短い間隔の遅延で十分

### 行動喚起

Databricksを使っているなら、すぐ始められます

- まずAI Gatewayでエンドポイントを作成
- 認証設定して渡すだけ
- 案Cで始めて、必要になったら案A/Bに移行
